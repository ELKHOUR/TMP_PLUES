{% load static %}
<div id="chatbot-widget">
    <!-- Chat Toggle Button -->
    <button id="chat-toggle" class="chat-toggle-btn" aria-label="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç">
        <span class="chat-icon">üí¨</span>
        <span class="notification-dot hidden"></span>
    </button>

    <!-- Chat Container -->
    <div id="chat-container" class="chat-container hidden">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-title">
                <h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç</h3>
                <p class="chat-subtitle">–ú—ã –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å –≤–∞–º</p>
            </div>
            <button id="chat-close" class="chat-close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç">
                ‚úï
            </button>
        </div>

        <!-- Messages Container -->
        <div id="messages" class="messages-container" role="log" aria-live="polite">
            <div class="welcome-message">
                <div class="bot-message">
                    <div class="message-content">
                        –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?
                    </div>
                    <div class="message-time">{{ current_time|time:"H:i" }}</div>
                </div>
            </div>
        </div>

        <!-- Quick Replies -->
        <div id="quick-replies" class="quick-replies">
            <button class="quick-btn" data-type="product" data-message="ÿ£ÿ±ŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ± ÿπŸÜ ŸÖŸÜÿ™ÿ¨">
                 –£–∑–Ω–∞—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–µ...
            </button>
            <button class="quick-btn" data-type="company" data-message="ÿ£ÿ±ŸäÿØ ŸÖÿπÿ±ŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ÿπŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ©">
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏...
            </button>
            <button class="quick-btn" data-type="our_serves" data-message="i wont to know this service">
               –£—Å–ª—É–≥–∏...
            </button>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="typing-indicator hidden">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">–ü–µ—á–∞—Ç–∞–µ—Ç...</span>
        </div>

        <!-- Chat Input -->
        <form id="chat-form" class="chat-form">
            {% csrf_token %}
            <div class="input-group">
                <input
                    id="chat-input"
                    type="text"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–¥–µ—Å—å..."
                    class="chat-input"
                    aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞"
                    maxlength="500"
                    name="q"
                />
                <button
                    type="submit"
                    class="send-btn"
                    aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
                    disabled
                >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
            <div class="input-footer">
                <span class="char-count">0/500</span>
            </div>
        </form>
    </div>
</div>

<!-- Styles -->
<style>
.chat-toggle-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 4rem;
    height: 4rem;
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1000;
}

.chat-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
}

.notification-dot {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 0.75rem;
    height: 0.75rem;
    background: #ef4444;
    border-radius: 50%;
    border: 2px solid white;
}

.chat-container {
    position: fixed;
    bottom: 7rem;
    right: 2rem;
    width: 24rem;
    height: 32rem;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;
}

.chat-header {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-title h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.chat-subtitle {
    margin: 0.25rem 0 0 0;
    font-size: 0.8rem;
    opacity: 0.9;
}

.chat-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.25rem;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: background 0.2s ease;
}

.chat-close-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.messages-container {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    background: #f8fafc;
}

.welcome-message {
    margin-bottom: 1rem;
}

.bot-message, .user-message {
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
}

.user-message {
    align-items: flex-end;
}

.bot-message {
    align-items: flex-start;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
}

.bot-message .message-content {
    background: white;
    border: 1px solid #e2e8f0;
    border-bottom-left-radius: 0.25rem;
}

.user-message .message-content {
    background: #dc2626;
    color: white;
    border-bottom-right-radius: 0.25rem;
}

.message-time {
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.25rem;
}

.quick-replies {
    padding: 0.75rem;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    background: white;
}

.quick-btn {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 1rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.quick-btn:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
}

.typing-indicator {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #64748b;
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
}

.typing-dots span {
    width: 0.5rem;
    height: 0.5rem;
    background: #64748b;
    border-radius: 50%;
    animation: typing-bounce 1.4s ease-in-out infinite both;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing-bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.chat-form {
    border-top: 1px solid #e2e8f0;
    padding: 0.75rem;
    background: white;
}

.input-group {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

.chat-input {
    flex: 1;
    border: 1px solid #e2e8f0;
    border-radius: 1.5rem;
    padding: 0.75rem 1rem;
    outline: none;
    transition: border-color 0.2s ease;
    resize: none;
    min-height: 2.5rem;
    max-height: 6rem;
}

.chat-input:focus {
    border-color: #dc2626;
}

.send-btn {
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 50%;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.send-btn:hover:not(:disabled) {
    background: #b91c1c;
    transform: scale(1.05);
}

.send-btn:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
    transform: none;
}

.input-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.25rem;
}

.char-count {
    font-size: 0.75rem;
    color: #64748b;
}

@media (max-width: 640px) {
    .chat-container {
        width: calc(100vw - 2rem);
        height: calc(100vh - 8rem);
        right: 1rem;
        bottom: 5rem;
    }

    .chat-toggle-btn {
        bottom: 1rem;
        right: 1rem;
    }
}

.hidden {
    display: none !important;
}

.fade-in {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(1rem); }
    to { opacity: 1; transform: translateY(0); }
}
.quick-btn.active {
    background-color: #dc2626;
    color: white;
    border-color: #b91c1c;
}

</style>

<!-- JavaScript -->
<script>
// ======= Chatbot API =======
class ChatbotAPI {
    constructor(csrfToken=null) {
        this.csrfToken = csrfToken || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        this.urlMap = {
            "product": "/chatbot/product/",
            "company": "/chatbot/company/",
            "our_serves": "/chatbot/services/",
            "general": "/chatbot/general/"
        };
    }



    async sendMessage(message, mode="general") {
        const url = this.urlMap[mode] || this.urlMap["general"];
        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": this.csrfToken
                },
                body: JSON.stringify({ message })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();

        return data.response || "–Ø –Ω–µ –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å.";
        } catch (err) {
            console.error("ChatbotAPI Error:", err);
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É üòû";
        }
    }
}







// ======= Chatbot UI =======
class ChatbotUI {
    constructor(api) {
        this.api = api;
        this.isOpen = false;
        this.currentMode = "general"; // ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä
        this.initializeElements();
        this.attachEventListeners();
    }

    initializeElements() {
        this.elements = {
            toggleBtn: document.getElementById('chat-toggle'),
            chatContainer: document.getElementById('chat-container'),
            closeBtn: document.getElementById('chat-close'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            messagesContainer: document.getElementById('messages'),
            quickReplies: document.getElementById('quick-replies'),
            typingIndicator: document.getElementById('typing-indicator'),
            charCount: document.querySelector('.char-count'),
            sendBtn: document.querySelector('.send-btn')
        };
    }







attachEventListeners() {
        // ŸÅÿ™ÿ≠ / ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ¥ÿßÿ™
        this.elements.toggleBtn.addEventListener('click', () => this.toggleChat());
        this.elements.closeBtn.addEventListener('click', () => this.closeChat());



let typingTimeout;

this.elements.chatInput.addEventListener('input', (e) => {
    const message = e.target.value.trim();

    // ÿ¥ÿ±ÿ∑: ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÉŸàÿØ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸàÿ∂ÿπ ÿπÿßŸÖ
    if ((this.currentMode || "general").toLowerCase() !== "general") return;

    // ŸÖÿ≥ÿ≠ ÿ£Ÿä ŸÖÿ§ŸÇÿ™ ÿ≥ÿßÿ®ŸÇ
    clearTimeout(typingTimeout);

    // ÿ™ÿ£ÿÆŸäÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞ 600ms ÿ®ÿπÿØ ÿ¢ÿÆÿ± ÿ≠ÿ±ŸÅ ŸÉÿ™ÿ®
    typingTimeout = setTimeout(async () => {

        if (message === "") {
            // ŸÑŸà ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÉŸÑ ÿßŸÑŸÜÿµÿå ÿßÿπÿ±ÿ∂ ÿßŸÑŸÄ 3 ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
            showDefaultButtons.call(this);
            return;
        }

        try {
            const response = await fetch(`/chatbot/search_CommonQuestions/?q=${encodeURIComponent(message)}`);
            const data = await response.json();

            this.elements.quickReplies.innerHTML = ''; // ŸÖÿ≥ÿ≠ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©

            if (data.CommonQuestions.length > 0) {
                // ÿπÿ±ÿ∂ ÿ£ŸàŸÑ 5 ŸÜÿ™ÿßÿ¶ÿ¨ ŸÅŸÇÿ∑
                data.CommonQuestions.slice(0, 4).forEach(CommonQuestion => {
                    const btn = document.createElement('button');
                    btn.classList.add('quick-btn');
                    btn.textContent = CommonQuestion.question_text;
                    btn.dataset.message = CommonQuestion.question_text;

                    btn.dataset.type = "general";
                    this.elements.quickReplies.appendChild(btn);
                });
            } else {
                // ŸÑŸà ŸÖŸÅŸäÿ¥ ŸÜÿ™ÿßÿ¶ÿ¨ÿå ÿßÿπÿ±ÿ∂ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                showDefaultButtons.call(this);
            }

        } catch (error) {
            console.error("ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´:", error);
        }

    }, 600); // ŸáŸÜÿß ÿßŸÑŸÄ debounce ÿ®ŸÄ 600ms
});

// ÿØÿßŸÑÿ© ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
function showDefaultButtons() {
    const defaultButtons = [
        { text: '–£–∑–Ω–∞—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–µ...', type: 'product', message: 'ÿ£ÿ±ŸäÿØ ÿßŸÑÿßÿ≥ÿ™ŸÅÿ≥ÿßÿ± ÿπŸÜ ŸÖŸÜÿ™ÿ¨' },
        { text: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏...', type: 'company', message: 'ÿ£ÿ±ŸäÿØ ŸÖÿπÿ±ŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ÿπŸÜ ÿßŸÑÿ¥ÿ±ŸÉÿ©' },
        { text: '–£—Å–ª—É–≥–∏... ', type: 'our_serves', message: 'i want to know this service' },
    ];

    this.elements.quickReplies.innerHTML = '';
    defaultButtons.forEach(btnData => {
        const btn = document.createElement('button');
        btn.classList.add('quick-btn');
        btn.dataset.type = btnData.type;
        btn.dataset.message = btnData.message;
        btn.textContent = btnData.text;
        this.elements.quickReplies.appendChild(btn);
    });
}








































        // ÿπÿØÿßÿØ ÿßŸÑÿ£ÿ≠ÿ±ŸÅ Ÿàÿ≤ÿ± ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
        this.elements.chatInput.addEventListener('input', (e) => {
            const length = e.target.value.length;
            this.elements.charCount.textContent = `${length}/500`;
            this.elements.sendBtn.disabled = length === 0;
        });

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑÿ•ÿØÿÆÿßŸÑ
        this.elements.chatForm.addEventListener('submit',async (e) => {
            e.preventDefault();
            const message = this.elements.chatInput.value.trim();

            if (message) {
                this.addUserMessage(message);
                this.elements.chatInput.value = '';
                this.elements.charCount.textContent = '0/500';
                this.elements.sendBtn.disabled = true;
                this.sendMessageToAPI(message, this.currentMode);
            }



            try {
                const response = await fetch("/chatbot/saveUpdateOne/", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''

                    },
                    body: JSON.stringify({ message })
                });



            }catch (error) {
                console.error('Error:', error);
                alert('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ!');
    }

    });





























     // ÿßŸÑÿ±ÿØŸàÿØ ÿßŸÑÿ≥ÿ±Ÿäÿπÿ© (ÿ≤ÿ± ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸàÿ∂ÿπ)
    this.elements.quickReplies.addEventListener('click', (e) => {
        const btn = e.target;

        if (btn.classList.contains('quick-btn')) {
            const message = btn.dataset.message;
            const mode = btn.dataset.type;

            // üîÅ Toggle behavior
            if (this.currentMode === mode) {
                // Same button clicked again ‚Üí deactivate
                this.currentMode = null;
                btn.classList.remove('active');
            } else {
                // New button ‚Üí activate it
                this.currentMode = mode;

                // Remove active class from all quick buttons
                document.querySelectorAll('.quick-btn').forEach((b) => b.classList.remove('active'));

                // Highlight current one
                btn.classList.add('active');

                // Add user message & send it
                this.addUserMessage(message);
                this.sendMessageToAPI(message, mode);
            }
        }
    });





}


    highlightActiveButton(activeButton) {
        const buttons = this.elements.quickReplies.querySelectorAll('.quick-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        activeButton.classList.add('active');
    }

    toggleChat() {
        this.isOpen = !this.isOpen;
        if (this.isOpen) {
            this.elements.chatContainer.classList.remove('hidden');
            this.elements.chatContainer.classList.add('fade-in');
            this.elements.chatInput.focus();
        } else {
            this.closeChat();
        }
    }

    closeChat() {
        this.isOpen = false;
        this.elements.chatContainer.classList.add('hidden');
    }

    addUserMessage(text) {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const html = `<div class="user-message fade-in"><div class="message-content">${text}</div><div class="message-time">${time}</div></div>`;
        this.elements.messagesContainer.insertAdjacentHTML('beforeend', html);
        this.scrollToBottom();
    }

    addBotMessage(text) {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const html = `<div class="bot-message fade-in"><div class="message-content">${text}</div><div class="message-time">${time}</div></div>`;
        this.elements.messagesContainer.insertAdjacentHTML('beforeend', html);
        this.scrollToBottom();
    }

    showTyping() {
        this.elements.typingIndicator.classList.remove('hidden');
        this.scrollToBottom();
    }

    hideTyping() {
        this.elements.typingIndicator.classList.add('hidden');
    }

    scrollToBottom() {
        this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
    }

    async sendMessageToAPI(message, mode="general") {
        this.showTyping();
        try {
            const reply = await this.api.sendMessage(message, mode);
            this.hideTyping();
            this.addBotMessage(reply);

        } catch (err) {
            this.hideTyping();
            this.addBotMessage("ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ üòû");
            console.error(err);
        }
    }
}




// ======= Initialize =======
document.addEventListener('DOMContentLoaded', () => {
    const api = new ChatbotAPI();
    new ChatbotUI(api);
});





</script>

